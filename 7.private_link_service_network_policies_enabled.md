# Task #7: private_link_service_network_policies_enabled - COMPLETED

## Summary
Successfully migrated `private_link_service_network_policies_enabled` (boolean) to `privateLinkServiceNetworkPolicies` (string) in Azure API. The provider converts boolean values to "Enabled"/"Disabled" strings via `expandSubnetNetworkPolicy()` and `flattenSubnetNetworkPolicy()` functions. This field has a default value of `true` which maps to "Enabled".

## Shadow Implementation

```hcl
# migrate_main.tf
locals {
  # Convert private_link_service_network_policies_enabled boolean to API string
  private_link_service_network_policies_value = var.private_link_service_network_policies_enabled != null ? ( # <-
    var.private_link_service_network_policies_enabled ? "Enabled" : "Disabled" # <-
  ) : "Enabled" # <-

  body = {
    properties = merge(
      # ... other fields ...
      { privateLinkServiceNetworkPolicies = local.private_link_service_network_policies_value } # <-
    )
  }
}
```

```hcl
# variables.tf (modified existing variable)
variable "private_link_service_network_policies_enabled" {
  type        = bool
  default     = true # <-
  nullable    = false # <-
  description = "(Optional) Enable or Disable network policies for the private link service on the subnet. Defaults to `true`."
}
```

## Create Phase Verification

### Pattern Identification
Query Create method confirms this is a **Single-Phase Create** pattern:

```go
func resourceSubnetCreate(d *pluginsdk.ResourceData, meta interface{}) error {
	// ... setup ...
	
	properties := subnets.SubnetPropertiesFormat{}
	
	// Field is assigned BEFORE the primary CreateOrUpdateThenPoll
	privateLinkServiceNetworkPoliciesRaw := d.Get("private_link_service_network_policies_enabled").(bool)
	privateLinkServiceNetworkPolicies = subnets.VirtualNetworkPrivateLinkServiceNetworkPolicies(expandSubnetNetworkPolicy(privateLinkServiceNetworkPoliciesRaw))
	properties.PrivateLinkServiceNetworkPolicies = pointer.To(privateLinkServiceNetworkPolicies)
	
	subnet := subnets.Subnet{
		Name:       pointer.To(id.SubnetName),
		Properties: &properties,
	}

	// Primary create operation
	if err := client.CreateOrUpdateThenPoll(ctx, id, subnet); err != nil {
		return fmt.Errorf("creating %s: %+v", id, err)
	}
	// ... waiting logic ...
}
```

**Decision:** Field is processed in the **Create Phase** (primary create operation). Implementation goes in `local.body`.

## Assignment Path Verification

### Predicted Path
`properties.privateLinkServiceNetworkPolicies`

### Go Code Evidence
From Create method:
```go
privateLinkServiceNetworkPoliciesRaw := d.Get("private_link_service_network_policies_enabled").(bool)
privateLinkServiceNetworkPolicies = subnets.VirtualNetworkPrivateLinkServiceNetworkPolicies(expandSubnetNetworkPolicy(privateLinkServiceNetworkPoliciesRaw))

properties.PrivateLinkServiceNetworkPolicies = pointer.To(privateLinkServiceNetworkPolicies)

subnet := subnets.Subnet{
	Name:       pointer.To(id.SubnetName),
	Properties: &properties,  // <-- Properties assignment
}
```

Assignment trace:
1. Value assigned to `properties.PrivateLinkServiceNetworkPolicies`
2. `properties` assigned to `subnet.Properties`
3. Final path: `Properties.PrivateLinkServiceNetworkPolicies`

### Verified Path
`properties.privateLinkServiceNetworkPolicies` (camelCase in JSON)

### Path Comparison
✅ **MATCH** - Predicted path matches verified path.

## Provider Schema

From `resourceSubnet()` schema definition:

```go
"private_link_service_network_policies_enabled": {
	Type:     pluginsdk.TypeBool,
	Optional: true,
	Default:  true,
},
```

**Key Properties:**
- **Type:** Boolean
- **Optional:** Yes
- **Default:** `true` (provider default)
- **ForceNew:** No (can be updated in-place)
- **Computed:** No
- **Sensitive:** No

### Conversion Functions

**Expand (Terraform → Azure API):**
```go
func expandSubnetNetworkPolicy(enabled bool) string {
	if enabled {
		return string(subnets.VirtualNetworkPrivateEndpointNetworkPoliciesEnabled)
	}
	return string(subnets.VirtualNetworkPrivateEndpointNetworkPoliciesDisabled)
}
```

**Flatten (Azure API → Terraform):**
```go
func flattenSubnetNetworkPolicy(input string) bool {
	return strings.EqualFold(input, string(subnets.VirtualNetworkPrivateEndpointNetworkPoliciesEnabled))
}
```

**Conversion Logic:**
- `true` → `"Enabled"`
- `false` → `"Disabled"`

### Update Behavior
```go
func resourceSubnetUpdate(d *pluginsdk.ResourceData, meta interface{}) error {
	// ...
	if d.HasChange("private_link_service_network_policies_enabled") {
		v := d.Get("private_link_service_network_policies_enabled").(bool)
		props.PrivateLinkServiceNetworkPolicies = pointer.To(subnets.VirtualNetworkPrivateLinkServiceNetworkPolicies(expandSubnetNetworkPolicy(v)))
	}
	// ... update via CreateOrUpdateThenPoll
}
```

The field can be updated in-place without forcing replacement.

## Azure API Schema

### Property Path
`properties.privateLinkServiceNetworkPolicies`

### API Schema Type
```
String
```

### API Documentation
From Azure API version 2024-07-01:
```
"privateLinkServiceNetworkPolicies": "Enable or Disable apply network policies on private link service in the subnet. (Possible values: Enabled,Disabled)"
```

### Valid Values
- `Enabled` - Network policies are enabled for private link service
- `Disabled` - Network policies are disabled for private link service

## Hidden Fields
None. This is a standard user-facing argument with no hidden values.

## Mapping

| Terraform Field (azurerm_subnet) | Azure API Field | Conversion |
|----------------------------------|-----------------|------------|
| `private_link_service_network_policies_enabled` (bool) | `privateLinkServiceNetworkPolicies` (string) | `true` → `"Enabled"`, `false` → `"Disabled"` |

**Naming Convention:**
- Terraform: `private_link_service_network_policies_enabled` (snake_case, boolean)
- Azure API: `privateLinkServiceNetworkPolicies` (camelCase, string enum)

## Special Handling

### 1. Default Value Replication
The provider schema specifies `Default: true`, which means:
- When the user doesn't provide a value, the provider defaults to `true`
- This translates to `"Enabled"` in the Azure API

**Implementation:** Modified the existing variable in `variables.tf` to add:
- `default = true` - matches provider default
- `nullable = false` - ensures the value is always present (since default is set)

This is a **root-level argument with a default**, following executor.md rules:
> **Top-level:** `variable "field" { type = ...; default = value; nullable = false }` - **CRITICAL:** Root/top-level arguments with defaults MUST have both `default` value AND `nullable = false` set

### 2. Type Conversion
The field requires boolean-to-string conversion:
- **Terraform Type:** `bool`
- **API Type:** `string` (enum: "Enabled" or "Disabled")

**Implementation:**
```hcl
locals {
  private_link_service_network_policies_value = var.private_link_service_network_policies_enabled != null ? (
    var.private_link_service_network_policies_enabled ? "Enabled" : "Disabled"
  ) : "Enabled"
}
```

The ternary expression replicates the exact behavior of `expandSubnetNetworkPolicy()`:
- `true` → `"Enabled"`
- `false` → `"Disabled"`
- `null` → `"Enabled"` (fallback to default, though with `nullable = false` this shouldn't occur)

### 3. No ForceNew Required
The schema does not specify `ForceNew: true` and the Update method shows the field can be changed:

```go
if d.HasChange("private_link_service_network_policies_enabled") {
	v := d.Get("private_link_service_network_policies_enabled").(bool)
	props.PrivateLinkServiceNetworkPolicies = pointer.To(subnets.VirtualNetworkPrivateLinkServiceNetworkPolicies(expandSubnetNetworkPolicy(v)))
}
```

**Decision:** No entry in `replace_triggers_external_values` needed.

## Edge Case Analysis

### Null Handling
- **Variable Configuration:** `nullable = false` with `default = true`
- **Meaning:** The value will never be null at runtime
- **Safety:** The local conversion includes a null check as a safety measure: `var.private_link_service_network_policies_enabled != null ? ... : "Enabled"`

### Boolean Values
- **`true`:** Converts to `"Enabled"` - network policies are applied to private link service
- **`false`:** Converts to `"Disabled"` - network policies are not applied to private link service

### Idempotency
- **First Apply:** Value is set to `"Enabled"` (default) or user-specified value
- **Subsequent Applies:** Value remains stable unless user changes it
- **No Drift:** Since we're using a direct conversion without external state reading, there's no risk of drift

### Safe References
- **Direct Variable Access:** The conversion logic directly references `var.private_link_service_network_policies_enabled`
- **No Nested Access:** No nested object/list access that could fail
- **Type Safety:** Boolean type ensures only `true`/`false` values are possible

## Deferred Work Completion
Checked `following.md` - file does not exist. No deferred work to complete.

## Checklist

- ✅ Property in correct local (`local.body.properties.privateLinkServiceNetworkPolicies`)
- ✅ ForceNew handling: Not required (field can be updated)
- ✅ ALL logic EXACTLY replicated from provider (boolean-to-string conversion via ternary matching `expandSubnetNetworkPolicy()`)
- ✅ Validations: None required (boolean type provides type safety)
- ✅ Default value replicated in `variables.tf` with `nullable = false`
- ✅ Hidden fields: None
- ✅ Deferred work: None
- ✅ Critical review completed
- ✅ Edge Case Analysis included
- ✅ Proof created
- ✅ `track.md` will be updated to "Pending for check"
- ✅ Self-Review: Only Task #7 content added (privateLinkServiceNetworkPolicies field)

## Implementation Review

### Exact Provider Behavior Replication
The implementation exactly replicates the provider's behavior:

1. **Expand Function Match:**
   ```go
   // Provider code
   func expandSubnetNetworkPolicy(enabled bool) string {
       if enabled {
           return string(subnets.VirtualNetworkPrivateEndpointNetworkPoliciesEnabled)  // "Enabled"
       }
       return string(subnets.VirtualNetworkPrivateEndpointNetworkPoliciesDisabled)  // "Disabled"
   }
   ```
   
   ```hcl
   // Our implementation
   private_link_service_network_policies_value = var.private_link_service_network_policies_enabled ? "Enabled" : "Disabled"
   ```

2. **Default Value Match:**
   - Provider: `Default: true`
   - Our implementation: `default = true, nullable = false`

3. **Update Behavior Match:**
   - Provider: Field can be updated via `HasChange` check and reassignment
   - Our implementation: No ForceNew constraint, allowing in-place updates

✅ **Implementation exactly matches provider behavior** with Go code evidence.

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2026-01-20
**Task:** #7 - private_link_service_network_policies_enabled

### Validation Results

✅ **ForceNew Logic:** Not required - field can be updated in-place (no ForceNew in schema or CustomizeDiff)
✅ **Stable Keys:** Field key is always present in `local.body.properties` (not conditionally added)
✅ **Phase Detection:** Field correctly placed in `local.body` (Create phase)
✅ **Type Conversion:** Exact conversion from bool to string via ternary matching `expandSubnetNetworkPolicy()`: `true` → `"Enabled"`, `false` → `"Disabled"`
✅ **Null Handling:** Correctly propagates null semantics with `nullable = false` and `default = true`, plus safety fallback
✅ **Validations:** None required (boolean type provides type safety)
✅ **Default Value:** Root-level argument correctly has both `default = true` AND `nullable = false` (MANDATORY per executor.md)
✅ **Deferred Work Completion:** No deferred work for this task in following.md
✅ **Deferred Work Recording:** No deferrals made by this task
✅ **Edge Cases:** All edge cases properly analyzed and handled (null, boolean values, idempotency)

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`. The boolean-to-string conversion matches the provider's `expandSubnetNetworkPolicy()` function precisely. The default value implementation follows the mandatory rule for root-level arguments with defaults (both `default` and `nullable = false`). No deviations, simplifications, or "safer alternatives" were found.

**Status:** APPROVED ✅

---
