# Task #10: sharing_scope - Proof Document

## Summary

Implemented `sharing_scope` as an Optional String field that maps to `properties.sharingScope` in the Azure API. The field is updatable (not ForceNew) and includes validations: (1) only "Tenant" value is allowed when set, and (2) cross-field validation ensuring `sharing_scope` cannot be set when `default_outbound_access_enabled` is `true` (deferred from Task #5). The field allows sharing subnet with other subscriptions in your AAD tenant.

## Shadow Implementation

```hcl
# variables.tf
variable "sharing_scope" {  # <-
  type        = string  # <-
  default     = null  # <-
  description = "(Optional) Set this property to Tenant to allow sharing subnet with other subscriptions in your AAD tenant. Possible values are `Tenant`. This property can only be set if `default_outbound_access_enabled` is set to `false`."  # <-

  validation {  # <-
    condition     = var.sharing_scope == null || var.sharing_scope == "Tenant"  # <-
    error_message = "sharing_scope must be \"Tenant\" when set."  # <-
  }  # <-

  validation {  # <-
    condition     = var.sharing_scope == null || !var.default_outbound_access_enabled  # <-
    error_message = "`sharing_scope` cannot be set if `default_outbound_access_enabled` is set to `true`"  # <-
  }  # <-
}  # <-

# migrate_main.tf
locals {
  body = {
    properties = merge(
      # ... other fields ...
      var.sharing_scope != null ? { sharingScope = var.sharing_scope } : {}  # <-
    )
  }
}
```

## Create Phase Verification

**Query Method:** `query_terraform_block_implementation_source_code(block_type="resource", terraform_type="azurerm_subnet", entrypoint_name="create")`

**Pattern Identification:** Single-phase operation

**Go Code Evidence (Create):**
```go
properties.SharingScope = pointer.ToEnum[subnets.SharingScope](d.Get("sharing_scope").(string))

subnet := subnets.Subnet{
    Name:       pointer.To(id.SubnetName),
    Properties: &properties,
}

if err := client.CreateOrUpdateThenPoll(ctx, id, subnet); err != nil {
    return fmt.Errorf("creating %s: %+v", id, err)
}
```

**Field Classification:** Create phase - assigned directly to `properties.SharingScope` before the primary `CreateOrUpdateThenPoll` call.

**Decision:** Implement in `local.body.properties` (not in post-creation operations).

## Assignment Path Verification

**Predicted Path:** `properties.sharingScope`

**Go Code Trace:**
1. Field read: `d.Get("sharing_scope").(string)` → returns string value
2. Assignment: `properties.SharingScope = pointer.ToEnum[subnets.SharingScope](d.Get("sharing_scope").(string))`
3. Struct construction: `subnet := subnets.Subnet{Name: ..., Properties: &properties}`
4. API call: `client.CreateOrUpdateThenPoll(ctx, id, subnet)`

**Path Trace:**
- Variable → `properties.SharingScope` (Go struct field)
- Struct field `SharingScope` serializes to JSON as `sharingScope` (camelCase)
- Final path: `properties.sharingScope`

**Verified Path:** `properties.sharingScope`

**Comparison:** Predicted path matches verified path ✅

## Provider Schema

**Source:** `query_terraform_block_implementation_source_code(block_type="resource", terraform_type="azurerm_subnet", entrypoint_name="schema")`

```go
"sharing_scope": {
    Type:     pluginsdk.TypeString,
    Optional: true,
    // todo "Tenant" is only supported until https://github.com/Azure/azure-rest-api-specs/issues/36446 is addressed
    ValidateFunc: validation.StringInSlice([]string{string(subnets.SharingScopeTenant)}, false),
},
```

**Field Properties:**
- **Type:** String
- **Required:** No (Optional: true)
- **ForceNew:** No (not specified)
- **Default:** None
- **Validation:** `StringInSlice(["Tenant"], false)` - only "Tenant" value is currently supported
- **Computed:** No

## Azure API Schema

**Query:** `query_azapi_resource_schema` and `query_azapi_resource_document` with `resource_type="Microsoft.Network/virtualNetworks/subnets"`, `api_version="2024-07-01"`, `path="body.properties.sharingScope"`

**Schema Type:** `String`

**Description:** "Set this property to Tenant to allow sharing subnet with other subscriptions in your AAD tenant. This property can only be set if defaultOutboundAccess is set to false, both properties can only be set if subnet is empty. (Possible values: Tenant,DelegatedServices)"

**Property Path:** `properties.sharingScope`

**Note:** The Azure API documentation mentions "Possible values: Tenant,DelegatedServices", but the AzureRM provider currently only supports "Tenant" value based on the validation in the schema.

## Hidden Fields

None. The field is explicitly defined in the provider schema.

## Mapping

- **Terraform (AzureRM):** `sharing_scope` (snake_case)
- **Azure API:** `sharingScope` (camelCase)
- **Type:** String → String (direct mapping)

## Special Handling

### Validations

**1. Value Constraint Validation:**

From provider schema:
```go
ValidateFunc: validation.StringInSlice([]string{string(subnets.SharingScopeTenant)}, false),
```

**Implementation in variables.tf:**
```hcl
validation {
  condition     = var.sharing_scope == null || var.sharing_scope == "Tenant"
  error_message = "sharing_scope must be \"Tenant\" when set."
}
```

**Rationale:** Replicates the `StringInSlice` validation exactly. Only "Tenant" value is allowed when the field is set.

**2. Cross-Field Validation with default_outbound_access_enabled:**

From provider CustomizeDiff:
```go
pluginsdk.CustomizeDiffShim(func(ctx context.Context, diff *pluginsdk.ResourceDiff, v interface{}) error {
    // Validate `sharing_scope` cannot be set when `default_outbound_access_enabled` is true.
    if diff.Get("sharing_scope").(string) != "" && diff.Get("default_outbound_access_enabled").(bool) {
        return fmt.Errorf("`sharing_scope` cannot be set if `default_outbound_access_enabled` is set to `true`")
    }
    return nil
}),
```

**Implementation in variables.tf:**
```hcl
validation {
  condition     = var.sharing_scope == null || !var.default_outbound_access_enabled
  error_message = "`sharing_scope` cannot be set if `default_outbound_access_enabled` is set to `true`"
}
```

**Rationale:** 
- This validation was deferred from Task #5 to Task #10 per the ownership rule (the validation belongs to the `sharing_scope` variable).
- Error condition from provider: `sharing_scope != "" AND default_outbound_access_enabled == true`
- Terraform equivalent: `!(var.sharing_scope == null || !var.default_outbound_access_enabled)`
- This ensures users cannot set `sharing_scope` when `default_outbound_access_enabled` is `true`
- Uses Terraform 1.9+ cross-variable validation capability

### Update Behavior

From Update method:
```go
if d.HasChange("sharing_scope") {
    props.SharingScope = pointer.ToEnum[subnets.SharingScope](d.Get("sharing_scope").(string))
}
```

**Analysis:** The field is updatable. When changed, the new value is applied directly to `properties.SharingScope`. No ForceNew behavior.

**Implementation:** No ForceNew tracking needed. The field is not added to `replace_triggers_external_values`.

### Null Handling

**Provider behavior:**
```go
// Create/Update:
properties.SharingScope = pointer.ToEnum[subnets.SharingScope](d.Get("sharing_scope").(string))
```

**Analysis:** 
- When `sharing_scope` is null/empty, `pointer.ToEnum` with empty string results in zero value for the enum
- The field is omitted from the API request when null (standard Go JSON marshaling behavior for zero values)

**Implementation:**
```hcl
var.sharing_scope != null ? { sharingScope = var.sharing_scope } : {}
```

**Rationale:** Only include the field in the body when it's explicitly set (not null).

## Deferred Work Completion

**Deferred Work from following.md:**

| Deferred By | Deferred To | Type | Description | Status |
|-------------|-------------|------|-------------|--------|
| #5 | #10 | Validation | Cross-field validation: `sharing_scope` cannot be set if `default_outbound_access_enabled` is set to `true` (from CustomizeDiff) | ✅ Completed |

**Evidence of Completion:**

The cross-field validation has been implemented in the `sharing_scope` variable in `variables.tf`:

```hcl
validation {
  condition     = var.sharing_scope == null || !var.default_outbound_access_enabled
  error_message = "`sharing_scope` cannot be set if `default_outbound_access_enabled` is set to `true`"
}
```

This validation exactly replicates the CustomizeDiff logic from the provider:
```go
if diff.Get("sharing_scope").(string) != "" && diff.Get("default_outbound_access_enabled").(bool) {
    return fmt.Errorf("`sharing_scope` cannot be set if `default_outbound_access_enabled` is set to `true`")
}
```

The logic is equivalent:
- Provider error triggers when: `sharing_scope != "" AND default_outbound_access_enabled == true`
- Our validation fails when: `!(var.sharing_scope == null OR default_outbound_access_enabled == false)`
- These are logically identical (De Morgan's law)

**Status Update:** Updated `following.md` to mark this deferred work as "✅ Completed".

## Edge Case Analysis

### 1. Null Semantics
- **When null:** Field is omitted from API request body (standard Azure API behavior)
- **Meaning:** No sharing scope is configured for the subnet
- **Implementation:** Conditional inclusion: `var.sharing_scope != null ? { sharingScope = var.sharing_scope } : {}`

### 2. Empty String
- **Validation prevents it:** The validation `var.sharing_scope == null || var.sharing_scope == "Tenant"` ensures empty strings are invalid
- **Provider behavior:** The CustomizeDiff checks `diff.Get("sharing_scope").(string) != ""`, treating empty string as unset
- **Implementation:** Our validation rejects empty strings (they're neither null nor "Tenant")

### 3. Interaction with default_outbound_access_enabled
- **Critical constraint:** `sharing_scope` can only be set when `default_outbound_access_enabled` is `false`
- **Validated at plan time:** Cross-variable validation in `variables.tf` catches this before API call
- **User experience:** Clear error message explaining the constraint

### 4. Value Constraint
- **Only "Tenant" allowed:** Provider only supports "Tenant" value currently
- **Azure API supports more:** Documentation mentions "Tenant,DelegatedServices", but provider restricts to "Tenant"
- **Implementation:** Replicate provider's restriction exactly (not Azure API's broader support)

### 5. Idempotency
- **Direct string value:** No order-dependent operations
- **Safe:** Repeated applies with same value produce identical API requests

### 6. Update Behavior
- **Updates allowed:** Field can be changed without replacement
- **No ForceNew:** Not tracked in `replace_triggers_external_values`

## Checklist

- ✅ **Property in correct local:** Added to `local.body.properties` with conditional inclusion
- ✅ **ForceNew wrapped:** Not applicable - field is not ForceNew
- ✅ **ALL logic EXACTLY replicated:** Both validations (value constraint and cross-field) replicated exactly from provider
- ✅ **Validations IMPLEMENTED:** 
  - Value constraint validation: `var.sharing_scope == null || var.sharing_scope == "Tenant"`
  - Cross-field validation: `var.sharing_scope == null || !var.default_outbound_access_enabled`
- ✅ **TODO comment:** Not applicable - no sensitive fields, no migration to ephemeral variables
- ✅ **Hidden fields checked:** None found
- ✅ **Deferred work in following.md:** Not deferring any work to other tasks
- ✅ **Deferred work from following.md:** Completed cross-field validation deferred from Task #5, updated status in `following.md`
- ✅ **Critical review:** 
  - Null means omit field (correct Azure API behavior)
  - Only "Tenant" value allowed (exact provider restriction)
  - Cross-field constraint with `default_outbound_access_enabled` enforced
  - Direct string mapping (idempotent)
  - Update supported (no ForceNew)
- ✅ **Edge Case Analysis:** Documented in dedicated section above
- ✅ **Proof created:** This document
- ✅ **track.md update:** Will be updated to "Pending for check"
- ✅ **Self-Review:** Only implemented `sharing_scope` field (Task #10). Did not add fields from other tasks.

## Files Modified

1. **variables.tf:** Added `sharing_scope` variable with type, default, description, and two validation blocks
2. **migrate_main.tf:** Added `sharingScope` to `local.body.properties` with conditional inclusion
3. **following.md:** Updated deferred validation status to "✅ Completed"

## No Deviation from Provider Behavior

This implementation exactly replicates the provider's behavior:
- ✅ Value validation matches `StringInSlice(["Tenant"], false)` exactly
- ✅ Cross-field validation matches CustomizeDiff logic exactly  
- ✅ API path matches provider's assignment to `properties.SharingScope`
- ✅ Update behavior matches provider's `d.HasChange` handling
- ✅ Null handling matches provider's pointer behavior

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2026-01-20
**Task:** #10 - sharing_scope

### Validation Results

✅ **ForceNew Logic:** Not ForceNew - field is updatable as evidenced by provider's Update method handling via `d.HasChange("sharing_scope")`
✅ **Stable Keys:** Not applicable - field not in `replace_triggers_external_values`
✅ **Phase Detection:** Field correctly placed in `local.body.properties` (Create phase)
✅ **Type Conversion:** Direct string mapping (string → string)
✅ **Null Handling:** Correctly uses conditional inclusion pattern: `var.sharing_scope != null ? { sharingScope = var.sharing_scope } : {}`
✅ **Validations:** 
  - Value constraint validation exactly replicates `StringInSlice(["Tenant"], false)`
  - Cross-field validation with `default_outbound_access_enabled` correctly implements CustomizeDiff logic using Terraform 1.9+ cross-variable validation in variables.tf
  - Logic equivalence verified: Provider error condition `sharing_scope != "" AND default_outbound_access_enabled == true` matches Terraform validation failure condition via De Morgan's law
✅ **Deferred Work Completion:** Cross-field validation deferred from Task #5 properly completed and documented; following.md updated with "✅ Completed" status
✅ **Deferred Work Recording:** No new deferrals made by this task
✅ **Edge Cases:** Comprehensive edge case analysis covering null semantics, empty strings, cross-field interactions, value constraints, idempotency, and update behavior
✅ **Shared Path Merge:** No duplicate keys in properties merge - all keys unique (addressPrefix, addressPrefixes, defaultOutboundAccess, privateEndpointNetworkPolicies, privateLinkServiceNetworkPolicies, serviceEndpointPolicies, serviceEndpoints, sharingScope)
✅ **Assignment Path:** Correctly traced from `d.Get("sharing_scope")` → `properties.SharingScope` → `properties.sharingScope` in API JSON

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`. No deviations, simplifications, or "safer alternatives" were found. Both validations (value constraint and cross-field) are implemented precisely as specified in the provider schema and CustomizeDiff logic.

**Status:** APPROVED ✅

---
