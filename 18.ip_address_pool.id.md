# Task #18 - ip_address_pool.id Argument

## Summary

Implemented the `ip_address_pool.id` argument, mapping to Azure API's `ipamPoolPrefixAllocations[].pool.id`. This Required field specifies the Network Manager IPAM Pool ID from which to allocate IP address prefixes. Added validation to ensure the ID follows the correct Azure resource ID format.

## Task Type

Type 4: Block Argument - Replace comment placeholder within existing block skeleton.

## Create Phase Verification

### Query Create Method

Queried the Create method (`resourceSubnetCreate`) to identify how `ip_address_pool.id` is processed.

### Go Code Evidence

From Create method:
```go
properties.IPamPoolPrefixAllocations = expandSubnetIPAddressPool(d.Get("ip_address_pool").([]interface{}))
```

From expand function:
```go
func expandSubnetIPAddressPool(input []interface{}) *[]subnets.IPamPoolPrefixAllocation {
	if len(input) == 0 {
		return nil
	}

	outputs := make([]subnets.IPamPoolPrefixAllocation, 0)
	for _, v := range input {
		ipPoolRaw := v.(map[string]interface{})
		output := subnets.IPamPoolPrefixAllocation{}

		if v, ok := ipPoolRaw["number_of_ip_addresses"]; ok {
			output.NumberOfIPAddresses = pointer.To(v.(string))
		}

		if v, ok := ipPoolRaw["id"]; ok {
			output.Pool = &subnets.IPamPoolPrefixAllocationPool{
				Id: pointer.To(v.(string)),
			}
		}

		outputs = append(outputs, output)
	}

	return &outputs
}
```

### Pattern Classification

**Single-phase pattern**: The field is set directly on `properties.IPamPoolPrefixAllocations` before the primary `CreateOrUpdateThenPoll` call.

### Decision

Field is assigned in the Create phase, before the primary create operation. Therefore, it goes in `local.body.properties.ipamPoolPrefixAllocations`.

## Assignment Path Verification

### Predicted Path

`body.properties.ipamPoolPrefixAllocations[0].pool.id`

### Go Code Evidence - Struct Assignment Trace

**Step 1 - Expand function creates nested structure:**
```go
if v, ok := ipPoolRaw["id"]; ok {
	output.Pool = &subnets.IPamPoolPrefixAllocationPool{  // <- Creates "pool" nesting
		Id: pointer.To(v.(string)),  // <- "id" field
	}
}
```

**Step 2 - Output appended to array:**
```go
outputs = append(outputs, output)
```

**Step 3 - Assignment to properties:**
```go
properties.IPamPoolPrefixAllocations = expandSubnetIPAddressPool(d.Get("ip_address_pool").([]interface{}))
```

**Step 4 - Properties assigned to subnet:**
```go
subnet := subnets.Subnet{
	Name:       pointer.To(id.SubnetName),
	Properties: &properties,  // <- Adds "properties" nesting
}
```

### Verified Path

`body.properties.ipamPoolPrefixAllocations[0].pool.id`

### Path Comparison

✅ **MATCH** - Predicted path matches verified path exactly. The `id` field is nested within a `pool` object structure.

## Provider Schema

### Schema Definition

```go
"ip_address_pool": {
	Type:         pluginsdk.TypeList,
	Optional:     true,
	MaxItems:     1,
	ExactlyOneOf: []string{"address_prefixes", "ip_address_pool"},
	Elem: &pluginsdk.Resource{
		Schema: map[string]*pluginsdk.Schema{
			"id": {
				Type:         pluginsdk.TypeString,
				Required:     true,
				ValidateFunc: ipampools.ValidateIPamPoolID,
			},
			// ... other fields ...
		},
	},
},
```

### Schema Analysis

- **Type**: `TypeString`
- **Required**: Yes (when parent block is set)
- **ValidateFunc**: `ipampools.ValidateIPamPoolID` - validates Azure IPAM Pool resource ID format
- **ForceNew**: Not present (no `ForceNew: true`)
- **Sensitive**: No
- **Computed**: No

## Azure API Schema

### API Type

From Azure API schema query for `body.properties.ipamPoolPrefixAllocations`:
```
List(ObjectWithOptionalAttrs(map[string]Type{
  "numberOfIpAddresses":String, 
  "pool":ObjectWithOptionalAttrs(map[string]Type{
    "id":String
  }, []string{"id"})
}, []string{"numberOfIpAddresses", "pool"}))
```

### API Property Path

`body.properties.ipamPoolPrefixAllocations[].pool.id` (string within nested object within array)

### API Documentation

The `pool` object contains:
- `id` - The resource ID of the IPAM Pool

## Hidden Fields

### Analysis

The expand function only processes the two schema-defined fields (`id` and `number_of_ip_addresses`). No hidden fields for the `pool` structure.

**NONE** - No hidden fields found for `pool.id`.

## Mapping

### Terraform → Azure API

| Terraform Field | Azure API Field | Notes |
|----------------|----------------|-------|
| `ip_address_pool.id` | `ipamPoolPrefixAllocations[].pool.id` | Nested within pool object |

### Naming Convention

- snake_case → camelCase
- `id` → `id` (already camelCase)
- Nested structure: `pool.id` in API

## Special Handling

### Validation

**Provider Validation**: `ipampools.ValidateIPamPoolID`

This validates the Azure IPAM Pool resource ID format. The expected format is:
```
/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Network/networkManagers/{networkManagerName}/ipamPools/{ipamPoolName}
```

**Implementation in variables.tf**:
```hcl
validation {
  condition = var.ip_address_pool == null || can(regex(
    "^/subscriptions/[0-9a-fA-F]{8}-([0-9a-fA-F]{4}-){3}[0-9a-fA-F]{12}/resourceGroups/[^/]+/providers/Microsoft\\.Network/networkManagers/[^/]+/ipamPools/[^/]+$",
    var.ip_address_pool.id
  ))
  error_message = "The ip_address_pool.id must be a valid Network Manager IPAM Pool ID in the format: /subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Network/networkManagers/{networkManagerName}/ipamPools/{ipamPoolName}."
}
```

This regex validates:
- Subscription ID in UUID format
- Resource group name present
- Provider namespace `Microsoft.Network/networkManagers` correct
- Network manager name present
- IPAM pool name present

### No ForceNew

The field does NOT have `ForceNew: true` in the schema, and there is no CustomizeDiff logic that would make changes to this field trigger replacement. Therefore, it is NOT added to `replace_triggers_external_values`.

### Nested Structure

The field requires a nested `pool` object structure in the API:
```hcl
pool = {
  id = var.ip_address_pool.id
}
```

## Implementation

### Code Changes

**Shadow Implementation (for proof only):**

**File: `migrate_main.tf`**
```hcl
var.ip_address_pool != null ? {
  ipamPoolPrefixAllocations = [
    {
      # numberOfIpAddresses = ... # Task #19
      pool = {                                  # <-
        id = var.ip_address_pool.id            # <-
      }                                         # <-
    }
  ]
} : {}
```

**File: `variables.tf`**
```hcl
variable "ip_address_pool" {
  type = object({
    id                     = string
    number_of_ip_addresses = string
  })
  default     = null
  description = <<-EOT
 - `id` - (Required) The ID of the Network Manager IP Address Management (IPAM) Pool.
 - `number_of_ip_addresses` - (Required) The number of IP addresses to allocated to the subnet. The value must be a string that represents a positive number, e.g., `"100"`.
EOT

  validation {                                                           # <-
    condition = var.ip_address_pool == null || can(regex(               # <-
      "^/subscriptions/[0-9a-fA-F]{8}-([0-9a-fA-F]{4}-){3}[0-9a-fA-F]{12}/resourceGroups/[^/]+/providers/Microsoft\\.Network/networkManagers/[^/]+/ipamPools/[^/]+$", # <-
      var.ip_address_pool.id                                            # <-
    ))                                                                   # <-
    error_message = "The ip_address_pool.id must be a valid Network Manager IPAM Pool ID in the format: /subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Network/networkManagers/{networkManagerName}/ipamPools/{ipamPoolName}." # <-
  }                                                                      # <-
}
```

## Deferred Work Completion

### Check following.md

Checked `following.md` for any deferred work assigned to Task #18.

**Result**: No deferred work found for this task.

## Edge Case Analysis

### Null Semantics

- `var.ip_address_pool == null` → Entire `ip_address_pool` block omitted, this field not evaluated
- `var.ip_address_pool != null` → Field is required, `var.ip_address_pool.id` must be non-null (enforced by object type definition)

### Boundary Conditions

- **Empty string**: Prevented by validation regex (requires valid resource ID structure)
- **Invalid format**: Caught by validation at plan time
- **Non-existent resource**: Would fail at API call time (cannot validate existence at plan time)
- **Wrong resource type**: Caught by validation regex (must be `Microsoft.Network/networkManagers/.../ipamPools/...`)

### Idempotency

The field value is directly assigned without transformation - same input always produces same output. The resource ID is case-insensitive in Azure, but Terraform treats it as case-sensitive for diff detection (standard behavior).

### Safe References

The field access `var.ip_address_pool.id` is safe because:
1. The outer conditional `var.ip_address_pool != null` protects against null parent
2. The object type definition requires `id` to be present when the object exists
3. Terraform's type system ensures the field exists

## Checklist

- ✅ Property in correct local (`body.properties.ipamPoolPrefixAllocations[].pool.id`)
- ✅ Comment placeholder replaced with actual implementation
- ✅ Nested `pool` object structure created
- ✅ Validation implemented in `variables.tf` (IPAM Pool ID format)
- ✅ No ForceNew (field not in `replace_triggers_external_values`)
- ✅ Hidden fields checked (none for this field)
- ✅ No deferred work to record
- ✅ No deferred work to complete from following.md
- ✅ Critical review completed (null, edge, idempotent, safe refs)
- ✅ Edge Case Analysis included
- ✅ Proof created
- ✅ track.md ready to update to "Pending for check"
- ✅ Self-Review: Only `ip_address_pool.id` implemented, no other fields added

## Critical Review

### Exact Provider Behavior Replication

✅ **CONFIRMED** - Implementation exactly matches provider behavior:
- Field is assigned to `pool.id` nested structure (matches Go code)
- Validation replicates `ipampools.ValidateIPamPoolID` behavior
- No ForceNew logic (matches schema)
- No transformation of value (direct assignment like provider)

### No Deviations

This implementation contains NO deviations from the provider source code. Every aspect replicates the exact provider behavior:
- Path structure matches expand function
- Validation matches provider's ValidateFunc
- No additional logic added
- No provider logic omitted

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2026-01-20
**Task:** #18 - ip_address_pool.id

### Validation Results

✅ **ForceNew Logic:** No ForceNew required (field not in schema as ForceNew, no CustomizeDiff logic)
✅ **Stable Keys:** All keys properly managed by parent conditional, no dynamic appearance/disappearance
✅ **Phase Detection:** Field correctly placed in `local.body.properties.ipamPoolPrefixAllocations[].pool.id` (Create phase)
✅ **Type Conversion:** Direct string assignment, no conversion needed
✅ **Null Handling:** Correctly protected by parent conditional `var.ip_address_pool != null`
✅ **Validations:** IPAM Pool ID validation correctly implemented in `variables.tf` with proper regex and error message
✅ **Nested Structure:** Correctly creates `pool` object wrapper matching Go code structure
✅ **Deferred Work Completion:** No deferred work for this task (verified in following.md)
✅ **Deferred Work Recording:** No deferrals made
✅ **Edge Cases:** All edge cases properly analyzed (null semantics, validation, safe references)
✅ **Proof Document:** Complete with all mandatory sections, Go code evidence, path verification
✅ **Scope Compliance:** Only ip_address_pool.id implemented, Task #19 placeholder preserved

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`. No deviations, simplifications, or "safer alternatives" were found. The field placement, validation, nested structure, and all logic precisely match the provider's expand function and schema definition.

**Status:** APPROVED ✅

---
