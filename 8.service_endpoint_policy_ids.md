# Task #8: service_endpoint_policy_ids - Proof Document

## Summary
Implemented `service_endpoint_policy_ids` argument mapping from azurerm_subnet to azapi_resource. The field is Optional, takes a set of Service Endpoint Policy IDs, and transforms them into an array of objects with `id` properties in the Azure API format. No ForceNew, no DiffSuppressFunc, no special handling required.

## Shadow Implementation
```hcl
locals {
  body = {
    properties = merge(
      # ... other fields ...
      var.service_endpoint_policy_ids != null ? {
        serviceEndpointPolicies = [for id in var.service_endpoint_policy_ids : { id = id }]  # <-
      } : {}
    )
  }
}
```

## Create Phase Verification

### Pattern Classification
Single-phase operation - field is set during primary `CreateOrUpdateThenPoll`.

### Evidence from Create Method
```go
func resourceSubnetCreate(d *pluginsdk.ResourceData, meta interface{}) error {
    // ...
    properties := subnets.SubnetPropertiesFormat{}
    // ...
    
    serviceEndpointPoliciesRaw := d.Get("service_endpoint_policy_ids").(*pluginsdk.Set).List()
    properties.ServiceEndpointPolicies = expandSubnetServiceEndpointPolicies(serviceEndpointPoliciesRaw)
    
    // ...
    
    subnet := subnets.Subnet{
        Name:       pointer.To(id.SubnetName),
        Properties: &properties,
    }

    if err := client.CreateOrUpdateThenPoll(ctx, id, subnet); err != nil {
        return fmt.Errorf("creating %s: %+v", id, err)
    }
    // ...
}
```

The field is retrieved from Terraform state, expanded using `expandSubnetServiceEndpointPolicies`, assigned to `properties.ServiceEndpointPolicies`, and sent in the primary Create operation.

### Decision
Field belongs in `local.body.properties` (Create phase, not post-creation).

## Assignment Path Verification

### Predicted Path
`body.properties.serviceEndpointPolicies` (array of objects with `id` field)

### Provider Code Evidence - Expand Function
```go
func expandSubnetServiceEndpointPolicies(input []interface{}) *[]subnets.ServiceEndpointPolicy {
    output := make([]subnets.ServiceEndpointPolicy, 0)
    for _, policy := range input {
        policy := policy.(string)
        output = append(output, subnets.ServiceEndpointPolicy{Id: &policy})
    }
    return &output
}
```

The provider iterates through input IDs (from the set) and constructs an array of `ServiceEndpointPolicy` objects, each containing only an `Id` field.

### Provider Code Evidence - Assignment
```go
properties.ServiceEndpointPolicies = expandSubnetServiceEndpointPolicies(serviceEndpointPoliciesRaw)

subnet := subnets.Subnet{
    Name:       pointer.To(id.SubnetName),
    Properties: &properties,  // Properties assigned here
}
```

The expanded value is assigned to `properties.ServiceEndpointPolicies`, and `properties` is assigned to `subnet.Properties`.

### Verified Path
`properties.serviceEndpointPolicies` → `body.properties.serviceEndpointPolicies` in azapi_resource

### Path Comparison
✅ Match - Predicted and verified paths align.

## Provider Schema

```go
"service_endpoint_policy_ids": {
    Type:     pluginsdk.TypeSet,
    Optional: true,
    Elem: &pluginsdk.Schema{
        Type:         pluginsdk.TypeString,
        ValidateFunc: serviceendpointpolicies.ValidateServiceEndpointPolicyID,
    },
},
```

**Key Properties:**
- Type: Set (unordered collection)
- Optional: true (not required)
- ForceNew: false (can be updated)
- Sensitive: false
- Validation: `ValidateServiceEndpointPolicyID` - validates Service Endpoint Policy resource ID format (Azure Resource ID validation, skipped per executor.md rules)

## Azure API Schema

### Schema Type
```
List(ObjectWithOptionalAttrs(map[string]Type{
    "id":String, 
    "location":String, 
    "properties":ObjectWithOptionalAttrs(...), 
    "tags":Map(String)
}, [...]))
```

### Path
`body.properties.serviceEndpointPolicies`

### Description
"An array of service endpoint policies."

### Structure
Array of objects where each object has:
- `id` (String, optional): The Service Endpoint Policy resource ID
- `location`, `properties`, `tags`: Additional optional fields (not used by provider)

## Hidden Fields
None. The provider only sets the `id` field in each array element.

## Mapping

### Terraform (snake_case) → Azure API (camelCase)
- `service_endpoint_policy_ids` → `serviceEndpointPolicies`

### Data Structure Transformation
- **Input**: `set(string)` - unordered set of Service Endpoint Policy IDs
- **Output**: `List<Object>` - ordered array of objects, each with `{ id = "<policy-id>" }`

The transformation converts flat ID strings into structured objects expected by the Azure API.

## Special Handling

### ForceNew
**Not Required** - Schema does not have `ForceNew: true`, and no CustomizeDiff logic found for this field. Updates are supported in the Update method:

```go
func resourceSubnetUpdate(d *pluginsdk.ResourceData, meta interface{}) error {
    // ...
    if d.HasChange("service_endpoint_policy_ids") {
        serviceEndpointPoliciesRaw := d.Get("service_endpoint_policy_ids").(*pluginsdk.Set).List()
        props.ServiceEndpointPolicies = expandSubnetServiceEndpointPolicies(serviceEndpointPoliciesRaw)
    }
    // ...
}
```

### Sensitive
**Not Required** - Field is not marked as Sensitive in schema.

### Validation
The provider schema includes `ValidateServiceEndpointPolicyID` which validates the Azure Resource ID format. Per executor.md rules, we skip Azure Resource ID format validations as these are verified by resource references. The existing variable definition in `variables.tf` already has the correct type (`set(string)`) and no additional validation is needed.

### Post-Creation
**Not Applicable** - Field is set during the primary Create operation, not in a separate post-creation step.

### DiffSuppressFunc
**Not Present** - No DiffSuppressFunc in schema for this field.

## Deferred Work Completion
No work was deferred to this task in `following.md`.

## Critical Review & Edge Case Analysis

### Null Semantics
- `null` value → Field is omitted from API request (conditional merge in locals)
- Empty set `[]` → Still treated as null (Terraform set semantics), field omitted
- Provider behavior: When null or empty, `expandSubnetServiceEndpointPolicies` returns an empty array pointer, but conditional logic handles this

### Implementation Detail
The implementation uses:
```hcl
var.service_endpoint_policy_ids != null ? {
  serviceEndpointPolicies = [for id in var.service_endpoint_policy_ids : { id = id }]
} : {}
```

This correctly handles:
- `null` → Empty map, field not sent to API
- Empty set → Terraform treats empty sets as truthy, so this would evaluate to `{ serviceEndpointPolicies = [] }`, sending empty array to API
- Non-empty set → Transforms each ID string to `{ id = "<id>" }` object

### Edge Cases
1. **Empty Set**: The condition `var.service_endpoint_policy_ids != null` will be true even for empty sets in Terraform, resulting in `serviceEndpointPolicies = []` sent to API. This matches provider behavior where `expandSubnetServiceEndpointPolicies([])` returns `&[]` (pointer to empty array).

2. **Set Ordering**: Terraform sets are unordered, but the `for` expression creates an ordered list. The Azure API receives an ordered array. However, since Service Endpoint Policies are reference-based and order-independent, this is acceptable and matches provider behavior.

3. **Null vs Empty**: The provider distinguishes between null (field not set) and empty array (explicitly cleared). Implementation correctly preserves this distinction.

4. **Duplicate IDs**: Terraform set type automatically deduplicates, so duplicates are impossible at input level.

### Idempotency
✅ Idempotent - Same input set produces same API payload. Set ordering doesn't affect functionality since policies are reference-based.

### Safe References
✅ Safe - Direct iteration over set is safe; null check prevents iteration on null value.

### Boundary Conditions
- No minimum/maximum size constraints in provider schema
- Each element must be a valid Service Endpoint Policy ID (format validated by provider, enforcement skipped per rules)

## Checklist

- ✅ Property in correct local (`body.properties.serviceEndpointPolicies`)
- ✅ ForceNew handling: Not required (field is updatable)
- ✅ ALL logic EXACTLY replicated from provider (expand function logic matches)
- ✅ Validations: Azure Resource ID validation skipped per rules, type validation inherent in variable definition
- ✅ Hidden fields checked: None found
- ✅ Deferred work checked: None for this task
- ✅ Critical review completed (null, edge cases, idempotency, safe references)
- ✅ Edge Case Analysis included above
- ✅ Proof created
- ✅ Ready for track.md update

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2026-01-20
**Task:** #8 - service_endpoint_policy_ids

### Validation Results

✅ **ForceNew Logic:** Not required - field is updatable (schema `ForceNew: false`, no CustomizeDiff)
✅ **Stable Keys:** N/A - field is not ForceNew
✅ **Phase Detection:** Field correctly placed in `local.body.properties` (Create phase)
✅ **Type Conversion:** Correct conversion from `set(string)` to `List<Object>` with `id` property
✅ **Null Handling:** Correctly propagates null semantics via conditional merge
✅ **Validations:** Azure Resource ID validation correctly skipped per executor.md rules (line 119-120)
✅ **Sensitive Fields:** Not sensitive - correctly placed in `body`, not `sensitive_body`
✅ **Assignment Path:** Verified path `properties.serviceEndpointPolicies` matches implementation
✅ **Deferred Work Completion:** No deferred work for this task in following.md
✅ **Deferred Work Recording:** No deferrals made by this task
✅ **Edge Cases:** All edge cases properly analyzed (null, empty set, ordering, idempotency)
✅ **Shared Path Merge:** Field `serviceEndpointPolicies` appears only once - no merge conflicts
✅ **Implementation Quality:** Code matches proof, no syntax errors, properly integrated

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`. The field transformation from `set(string)` to array of objects with `id` property precisely matches the provider's `expandSubnetServiceEndpointPolicies` function. No deviations, simplifications, or "safer alternatives" were found.

**Status:** APPROVED ✅

---
